
#include "Control.h"
#include "ArduinoUSB.h"

const uint16_t MOTOR_MAX = 2000;
const uint16_t MOTOR_MIN = 700;

class_Control Control;

class_Control::class_Control() {
}

class_Control::~class_Control() {
}

void class_Control::initialize() {
	
    ratePitchPID.initialize(16, 10, 0, 400);
    rateRollPID.initialize(20, 0, 0, 400);
    yawPID.initialize(7, 0.01, 0, 200);
    attitudePitchPID.initialize(4, 0, 0, 300);
    attitudeRollPID.initialize(1.5, 0, 0, 300);
	//f = fopen("pwm.txt","w");

}


void class_Control::update() {

	ArduinoUSB.getReceiver();
	attitudeControl_();

}


void class_Control::calibrate() {
	ArduinoUSB.pwmWidths.frontLeft = 200;
	ArduinoUSB.pwmWidths.frontRight = 200;
	ArduinoUSB.pwmWidths.rearLeft = 200;
	ArduinoUSB.pwmWidths.rearRight =200;
	ArduinoUSB.setPWM();
	getchar();
	getchar();
	ArduinoUSB.pwmWidths.frontLeft = 0;
	ArduinoUSB.pwmWidths.frontRight = 0;
	ArduinoUSB.pwmWidths.rearLeft = 0;
	ArduinoUSB.pwmWidths.rearRight = 0;
	ArduinoUSB.setPWM();
	}


inline void class_Control::updatePWM_(double* pitch, double* roll, double* yaw) {
    ArduinoUSB.pwmWidths.frontLeft =  ((ArduinoUSB.receiverData.RCThrottle * (MOTOR_MAX - MOTOR_MIN)) + MOTOR_MIN)  - *roll + *pitch +*yaw;
	antiSaturation_(&ArduinoUSB.pwmWidths.frontLeft);
    ArduinoUSB.pwmWidths.frontRight = ((ArduinoUSB.receiverData.RCThrottle * (MOTOR_MAX - MOTOR_MIN)) + MOTOR_MIN)  + *roll + *pitch - *yaw;
	antiSaturation_(&ArduinoUSB.pwmWidths.frontRight);
    ArduinoUSB.pwmWidths.rearRight = ((ArduinoUSB.receiverData.RCThrottle * (MOTOR_MAX - MOTOR_MIN)) + MOTOR_MIN) + *roll - *pitch + *yaw;
	antiSaturation_(&ArduinoUSB.pwmWidths.rearRight);
    ArduinoUSB.pwmWidths.rearLeft = ((ArduinoUSB.receiverData.RCThrottle * (MOTOR_MAX - MOTOR_MIN)) + MOTOR_MIN) - *roll - *pitch - *yaw;
	antiSaturation_(&ArduinoUSB.pwmWidths.rearLeft);
//	std::cout <<  (MOTOR_MAX - MOTOR_MIN)/200.0 << std::endl;
	toPercents_(&ArduinoUSB.pwmWidths.frontLeft);
	toPercents_(&ArduinoUSB.pwmWidths.frontRight);
	toPercents_(&ArduinoUSB.pwmWidths.rearRight);
	toPercents_(&ArduinoUSB.pwmWidths.rearLeft);
//	printf("r.ang: %1f p.ang: %1f rcR.ang: %1f rcP.ang: %1f r.out: %1f p.out: %1f freq: %1f\n", AHRS.angles.roll, AHRS.angles.pitch, ArduinoUSB.receiverData.RCRoll, ArduinoUSB.receiverData.RCPitch, *roll, *pitch, 1/Timer.dt);
	//fprintf(f,"pwms: %4hd %4hd %4hd %4hd %1f %1f \n", ArduinoUSB.pwmWidths.rearLeft, ArduinoUSB.pwmWidths.rearRight,ArduinoUSB.pwmWidths.frontLeft, ArduinoUSB.pwmWidths.frontRight, AHRS.angles.roll, AHRS.angles.pitch);
	//fprintf(stderr, "roll: %1f pitch: %1f \n", AHRS.angles.roll, AHRS.angles.pitch);
    ArduinoUSB.setPWM();
}

inline void class_Control::antiSaturation_(uint16_t * target) {
	if (*target > MOTOR_MAX) {
		*target = MOTOR_MAX;
	} else if (*target < MOTOR_MIN) {
		*target = MOTOR_MIN;
	}
}

//8bit number is 256 max in dec.
//so we can increase accuracy by scaling to 200% not 100%
inline void class_Control::toPercents_(uint16_t * target) {
	*target = static_cast<uint16_t>((*target - MOTOR_MIN)/((MOTOR_MAX - MOTOR_MIN)/200.0));
}

void class_Control::attitudeControl_() {
    attitudePitchPID.calculate(&AHRS.angles.pitch, &ArduinoUSB.receiverData.RCPitch, &Timer.dt, &AHRS.operableData.gyr_x);
    attitudeRollPID.calculate(&AHRS.angles.roll, &ArduinoUSB.receiverData.RCRoll, &Timer.dt, &AHRS.operableData.gyr_y);
	//rateControl_(&ArduinoUSB.receiverData.RCPitch, &ArduinoUSB.receiverData.RCRoll);
    rateControl_(&attitudePitchPID.output, &attitudeRollPID.output);
}

void class_Control::rateControl_(double* pitchrate, double* rollrate) {
	double zero = 0;
	yawPID.calculate(&AHRS.operableData.gyr_z, &ArduinoUSB.receiverData.RCYaw, &Timer.dt, &zero);
    ratePitchPID.calculate(&AHRS.operableData.gyr_x, pitchrate, &Timer.dt, &zero);
    rateRollPID.calculate(&AHRS.operableData.gyr_y, rollrate, &Timer.dt, &zero);
    updatePWM_(&ratePitchPID.output, &rateRollPID.output, &yawPID.output);
}

void class_Control::setRatePID(float KP, float KI, float KD) {
    ratePitchPID.setPID(KP, KI, KD);
    rateRollPID.setPID(KP, KI, KD);
}

void class_Control::getRatePID() {
    ratePitchPID.getPID();
    rateRollPID.getPID();
}

void class_Control::setAttitudePID(float KP, float KI, float KD) {
    attitudePitchPID.setPID(KP, KI, KD);
    attitudeRollPID.setPID(KP, KI, KD);
}

void class_Control::getAttitudePID() {
    attitudePitchPID.getPID();
    attitudeRollPID.getPID();
}

